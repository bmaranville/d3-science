<!DOCTYPE html>
<meta charset="utf-8">
<style>
html, body {
  height: 100%;
  overflow: hidden;
}
svg {
  width: 100%;
  height: 100%;
  float: left;
  border-bottom: solid 1px #ccc;
  border-right: solid 1px #ccc;
  margin-right: -1px;
  margin-bottom: -1px;
}

#editor_div { 
  width: 100%;
  height: 100%;
}
.highlight {
  fill-opacity: 0.2 !important;
}
.popup {
    position: absolute;
    background-color: #fff;
    /*width: 200px;*/
    border: 1px #ccc solid;
    border-radius: 6px;
    box-shadow: #333 2px 2px 4px;
    font-family: arial, helvetica, sans-serif;
    margin: 5px 5px 2px 2px;
}
.popup ul {
    padding: 5px;
    list-style-type: none;
    margin: 0;
}

.popup ul li {
    margin-top: 2px;
    margin-bottom: 2px;
    margin-right: 0px;
    margin-left: 0px;
    cursor: pointer;
}
.popup ul li:hover {
    background-color: LightGray;
}

.popup hr {
    margin: 0;
}

.input.label, .output.label {
    display: none;
}

/* styles for dataflow editor */

g.exposed-terminals rect, g.module rect {
  stroke-width: 2px;
  stroke: blue;
  cursor: move;
  fill: white;
}

g.module rect.title {
  fill-opacity: 0;
}

g.module rect.terminal { 
  cursor: crosshair;
}

rect.terminal.output, rect.terminal.exposed.input {
  fill: #88FFFF;
}

rect.terminal.input, rect.terminal.exposed.output {
  fill:  #88FF88;
}

path.wire, path.exposed-wire {
  fill: none;
  stroke-width: 5px;
  stroke: red;
  cursor: crosshair;
}

path.exposed-wire {
  stroke: blue;
  stroke-opacity: 0.4;
}

polygon.terminal.state {
  display: none;
}

</style>
<body>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="../lib/jquery-extend.js"></script>
<!--<script src="dataflow-box-module.js"></script>-->
<script src="../lib/dataflow-editor.js"></script>
<script src="ncnr.refl.module_defs.js"></script>
<script>
window.onload = function() {

current_instrument = 'ncnr.refl';

var x0 = 150,
    y0 = 100, 
    dx = 135,
    dy = 40;

example = {
  "inputs": [
    {
      "id": "input_0",
      "target": [
        10,
        "base"
      ]
    },
    {
      "id": "input_1",
      "target": null
    }
  ],
  "outputs": [
    {
      "id": "output_0",
      "target": [
        10,
        "output"
      ]
    }
  ],
  "modules": [
    {
      "title": "load spec long title",
      "module": "ncnr.refl.super_load",
      "config": {
        "intent": "specular"
      },
      "x": 85,
      "y": 80
    },
    {
      "title": "load bg",
      "module": "ncnr.refl.super_load",
      "config": {
        "intent": "background"
      },
      "x": 150,
      "y": 140
    },
    {
      "title": "load slit",
      "module": "ncnr.refl.super_load",
      "config": {
        "intent": "slit"
      },
      "x": 150,
      "y": 180
    },
    {
      "title": "mask",
      "module": "ncnr.refl.mask_points",
      "x": 285,
      "y": 100
    },
    {
      "title": "mask",
      "module": "ncnr.refl.mask_points",
      "x": 285,
      "y": 140
    },
    {
      "title": "mask",
      "module": "ncnr.refl.mask_points",
      "x": 285,
      "y": 180
    },
    {
      "title": "join",
      "module": "ncnr.refl.join",
      "x": 420,
      "y": 100
    },
    {
      "title": "join",
      "module": "ncnr.refl.join",
      "x": 420,
      "y": 140
    },
    {
      "title": "join",
      "module": "ncnr.refl.join",
      "x": 421,
      "y": 179
    },
    {
      "title": "subtract",
      "module": "ncnr.refl.subtract_background",
      "x": 555,
      "y": 100
    },
    {
      "title": "normalize",
      "module": "ncnr.refl.divide_intensity",
      "x": 710,
      "y": 30
    }
  ],
  "wires": [
    {
      "source": [
        0,
        "output"
      ],
      "target": [
        3,
        "data"
      ]
    },
    {
      "source": [
        1,
        "output"
      ],
      "target": [
        4,
        "data"
      ]
    },
    {
      "source": [
        2,
        "output"
      ],
      "target": [
        5,
        "data"
      ]
    },
    {
      "source": [
        3,
        "output"
      ],
      "target": [
        6,
        "data"
      ]
    },
    {
      "source": [
        4,
        "output"
      ],
      "target": [
        7,
        "data"
      ]
    },
    {
      "source": [
        5,
        "output"
      ],
      "target": [
        8,
        "data"
      ]
    },
    {
      "source": [
        6,
        "output"
      ],
      "target": [
        9,
        "data"
      ]
    },
    {
      "source": [
        7,
        "output"
      ],
      "target": [
        9,
        "backp"
      ]
    },
    {
      "source": [
        8,
        "output"
      ],
      "target": [
        9,
        "backm"
      ]
    },
    {
      "source": [
        9,
        "output"
      ],
      "target": [
        10,
        "data"
      ]
    }
  ]
}

function expand_module_defs(modules, instrument) {
  var output = [],
      module_defs = instruments[instrument].modules;
  for (var i=0; i<modules.length; i++) {
    var m = modules[i];
    output[i] = m;
    output[i].terminals = module_defs[m.module].terminals;
    output[i].fields = module_defs[m.module].fields;
  }
  return output
}

e = new dataflowEditor.editor(null, true);
e.module_defs(instruments[current_instrument].modules);
e.data([{modules: [], wires: []}]);
d3.select("#editor_div").call(e);


var contextMenuShowing = false;

e.svg().on('contextmenu',function (d,i) {
    if (contextMenuShowing) {
        d3.event.preventDefault();
        d3.select(".popup").remove();
        contextMenuShowing = false;
    } else {
        d3_target = d3.select(d3.event.target);
        if (d3_target.classed("wire")) {
            d3.event.preventDefault();
            contextMenuShowing = true;

            // Build the popup            
            popup = d3.select("#editor_div")
            .append("div")
            .attr("class", "popup")
            .style("left", d3.event.x + "px")
            .style("top", d3.event.y + "px")
            .append("ul")
            
            popup.append("li").text("delete").on("click", function() {
                var active_data = d3_target.datum();
                var parentNode = d3_target.node().parentNode;
                var wires = d3.select(parentNode).datum().wires;
                for (var i=0; i<wires.length; i++) {
                    var w = wires[i]; 
                    if (w.source == active_data.source && w.target == active_data.target) {
                        wires.splice(i,1);
                        break;
                    }
                };
                e.update();
                d3.select(".popup").remove(); 
                contextMenuShowing=false;
            });
            
        }
        else if (d3_target.classed("exposed-wire")) {
            d3.event.preventDefault();
            contextMenuShowing = true;

            // Build the popup            
            popup = d3.select("#editor_div")
            .append("div")
            .attr("class", "popup")
            .style("left", d3.event.x + "px")
            .style("top", d3.event.y + "px")
            .append("ul")
            
            popup.append("li").text("delete").on("click", function() {
                var active_data = d3_target.datum();
                if (active_data.source[0] == -1) {
                  e.svg().datum().inputs.forEach(function(f) { 
                    if (f.id == active_data.source[1]) {
                      f.target = null;
                    }
                  });
                }
                if (active_data.target[0] == -1) {
                  e.svg().datum().outputs.forEach(function(f) { 
                    if (f.id == active_data.target[1]) {
                      f.target = null;
                    }
                  });
                }
                e.update();
                d3.select(".popup").remove(); 
                contextMenuShowing=false;
            });
        }
        else if (d3_target.classed("title")) {
            d3.event.preventDefault();
            contextMenuShowing = true;

            // Build the popup            
            popup = d3.select("#editor_div")
            .append("div")
            .attr("class", "popup")
            .style("left", d3.event.x + "px")
            .style("top", d3.event.y + "px")
            .append("ul")
            
            var active_data = d3_target.datum();
            var module_index = d3_target.node().parentNode.parentNode.getAttribute("index");
            var module_def = active_data.module_def || e.module_defs()[active_data.module];
            var fields = module_def.fields || [];
            popup.append("li").text("configure").on("click", function() {
              alert("implement configure");
              d3.select(".popup").remove(); 
              contextMenuShowing=false;
            });
            popup.append("hr");
            popup.append("li").append("span").text("fields").style("font-weight", "bold")
            var expose_fields = popup.append("li").append("ul");
            var fields_list = expose_fields.selectAll("li").data(fields)
              .enter().append("li")
            fields_list.append("span")
                .text(function(d) { return d.id + " exposed as: " })
            fields_list.append("input")
              .attr("type", "text")
              .classed("exposed_as", true)
              .attr("value", function(d) { return d.id })
              .attr("size", "10")
            fields_list.append("input")
              .attr("type", "checkbox")
              .property("checked", function(d) { return check_exposed(module_index, d.id) })
              .on("change", function(d) {
                var exposed_as = d3.select(this.parentNode).select("input.exposed_as").node().value;
                var success = set_field(this.checked, module_index, d.id, exposed_as);
                if (!success) { this.checked = false }
              });
            popup.append("hr")
            var buttons = popup.append("li").style("text-align", "right")
            buttons
              .append("button").text("dismiss")
                .on("click", function() {
                  d3.select(".popup").remove(); 
                  e.update();
                  contextMenuShowing=false;
                });
            buttons
              .append("button").text("delete module")
                .on("click", function() {
                  var module_id = d3_target.datum().module_id;
                  e.svg().datum().modules = e.svg().datum().modules.filter(function(d) { return d.module_id != module_id});
                  d3.select(".popup").remove(); 
                  e.update();
                  contextMenuShowing=false;
                });
        }
        else if ((d3_target.classed("input") || d3_target.classed("output")) && d3_target.classed("exposed")) {
            d3.event.preventDefault();
            contextMenuShowing = true;

            // Build the popup            
            popup = d3.select("#editor_div")
            .append("div")
            .attr("class", "popup")
            .style("left", d3.event.x + "px")
            .style("top", d3.event.y + "px")
            .append("ul")
            
            var side = d3_target.classed("output") ? "inputs" : "outputs";
            //popup.append("li").text("configure").on("click", function() {alert("implement configure"); d3.select(".popup").remove(); contextMenuShowing=false;});
            
            popup.append("li").text("delete").on("click", function() {
                console.log(d3_target, d3.select(d3_target.node().parentNode.parentNode));
                //d3.select(d3_target.node().parentNode.parentNode).remove();
                var term_id = d3_target.datum().id;
                console.log(term_id);
                e.svg().datum()[side] = e.svg().datum()[side].filter(function(d) { 
                  return d.id != term_id
                });
                d3.select(".popup").remove(); 
                e.update();
                contextMenuShowing=false;
            });
            //refresh_inputs();
            //refresh_outputs();
        }
                     
    }
})

function set_field(enabled, module_index, fieldname, exposed_name) {
  if (enabled) {
    return expose_field(module_index, fieldname, exposed_name)
  }
  else {
    return unexpose_field(module_index, fieldname, exposed_name)
  }
}

function expose_field(module_index, fieldname, exposed_name) {
  var data = e.svg().datum();
  // check if this exposed name already exists:
  data.fields = data.fields || [];
  var existing_names = data.fields.map(function(f) { return f.id });
  if (existing_names.indexOf(exposed_name) > -1) {
    alert("this name is already used");
    return false
  }
  data.fields.push({
    "id": exposed_name,
    "target": [parseInt(module_index), fieldname]
  });
  return true
}

function unexpose_field(module_index, fieldname) {
  var data = e.svg().datum();
  data.fields = data.fields || [];
  data.fields = data.fields.filter(function(f) { 
    return !(f.target && f.target[0] == parseInt(module_index) && f.target[1] == fieldname)
  });
  return true
}

function check_exposed(module_index, fieldname) { 
  var data = e.svg().datum();
  var fields = data.fields || [];
  var matching = fields.filter(function(f) { 
    return (f.target && f.target[0] == parseInt(module_index) && f.target[1] == fieldname)
  })
  return (matching.length > 0)
}
  
var module_defs = instruments[current_instrument].modules,
    module_names = (["Add new module:"]).concat(Object.keys(module_defs));
    
d3.select("#new_module").selectAll("option").data(module_names)
  .enter().append('option')
  .attr("module", function(d) {return d}) // function(d) {return module_defs[d].module})
  .text(function(d) {return module_defs[d].name})  
  
d3.select('#new_module').on("change", function(ev) {
    var title = this.value,
        module = module_names[this.selectedIndex];
    e.data()[0].modules.push({module: module, title: title});
    e.update();
    this.selectedIndex=0;
});

d3.select("#show_value").on("click", function() { 
  var win = window.open();
  win.document.write("<pre>" + JSON.stringify(e.export(), null, 2) + "</pre>");
});

d3.select("#show_example").on("click", function() {
  e.import(example);
});

e.dispatch.on("update", function() { 
  var datum = e.svg().datum();
  var fields = datum.fields || [];
  e.svg().selectAll("g.module g.title text").text(function(d,i) { 
    var title = d.title;
    if (fields.filter(function(f) { return f.target[0] == i }).length > 0) {
      title += "*";
    }
    return title;
  });
});

function loadData() {
    var file = document.getElementById('upload_template').files[0]; // only one file allowed
    datafilename = file.name;
    var result = null;
    var reader = new FileReader();
    reader.onload = function(ev) {
        var template = JSON.parse(this.result);
        e.import(template);
    }
    reader.readAsText(file);
}

d3.select("#upload_template").on("change", loadData);

}
</script>
<div id="controls">
    <select id="new_module">
      <option>Add new module:</option>
    </select>
    <button id="show_example">Load example template</button>
    <input id="upload_template" type="file" multiple="false" name="upload_template" />
    <button id="show_value">Show data</button>
</div>
<div id="editor_div">
</div>
</body>
